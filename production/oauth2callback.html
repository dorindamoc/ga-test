<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title></title>
</head>

<body>
    <script>
        let urlParams = {}
        window.location.search
            .substring(1)
            .split('&')
            .forEach(function (kv) {
                kv = kv.split('=')
                urlParams[kv[0]] = decodeURIComponent(kv[1])
            })
        const redirectLocation =
            window.localStorage.getItem('locationBeforeLogin') || './'

        // Process the response to the preflight
        const code = urlParams['code']
        const state = urlParams['state']

        // Check for the preflight response params
        if (code === undefined || state === undefined) {
            throw `Missing params from preflight`
        }

        // Get the callbackdata from the storage
        const callbackData = JSON.parse(
            sessionStorage.getItem('callbackData')
        )
        if (!callbackData) {
            throw 'Callback data not found!'
        }
        const { callbackURL, codeVerifier } = callbackData
        localStorage.removeItem('locationBeforeLogin')

        // Make the postfligth call and process the response
        const postflightRequest = `${callbackURL}?code=${code}&state=${state}&code_verifier=${encodeURIComponent(
            codeVerifier
        )}`

        fetch(postflightRequest)
            .then((response) => {
                // Check for the response code
                if (!response.ok) {
                    throw `Postflight response: ${response.status} - ${response.statusText}`
                }
                return response.json()
            })
            .then((jsonResponse) => {
                // Check for the response status
                if (jsonResponse.status === 'error') {
                    if (
                        window.localStorage.getItem('locationIfLoginFails')
                    ) {
                        window.localStorage.setItem(
                            'locationBeforeLogin',
                            window.localStorage.getItem(
                                'locationIfLoginFails'
                            )
                        )
                    }

                    // if (jsonResponse.reason === 'user_disabled') {
                    // Here handle the undelete feature when available
                    //  }

                    throw `Postflight error response: ${jsonResponse.reason}`
                }
                if (jsonResponse.status === 'success') {
                    const serviceDict = {
                        appHost: jsonResponse.data.service['app-host'],
                        thumbHost: jsonResponse.data.service['thumb-host'],
                        videoHost: jsonResponse.data.service['video-host'],
                        pollHost: jsonResponse.data.service['poll-host'],
                        downloadHost: jsonResponse.data.service['download-host'],
                    }

                    // Set the state and authentificate
                    window.sessionStorage.setItem(
                        'authToken',
                        jsonResponse.data.auth
                    )
                    window.sessionStorage.setItem(
                        'serviceDict',
                        JSON.stringify(serviceDict)
                    )

                    if (jsonResponse.data.user_creation === '1') {
                        window.sessionStorage.setItem('userCreated', '1')
                    }

                    if (jsonResponse.data.td_sls !== '1') {
                        window.localStorage.setItem(
                            'authToken',
                            jsonResponse.data.auth
                        )
                        window.localStorage.setItem(
                            'serviceDict',
                            JSON.stringify(serviceDict)
                        )
                    }

                    window.location.replace(redirectLocation)
                }
                if (jsonResponse.status === 'failed') {
                    if (jsonResponse.reason === 'USER_DISABLED') {
                        window.location.replace(jsonResponse.undelete_url)
                    }
                }
            })
            .catch(console.error())
    </script>
    Loading...
</body>

</html>